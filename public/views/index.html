<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />

    <title>Todoアプリ</title>
  </head>
  <body>
    <div class="container">
      <!-- <form>
        <input type="text" id="debug-task">
      </form> -->
      <div id="debug-delete" data-delete="リセットするなや～！！！">タスクを削除</div>
      <button type="button" class="btn btn-danger" id="delete-test">消したるわ</button>
      <!-- Content here -->
      <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#add">
        <b>＋タスクを追加</b>
      </button>
      <ul id="list-group" class="list-group">
        <li class="list-group-item category c1"> <!--class list-group-item category-orange-->
          <div class="row align-items-center">
            <span class="col-sm-8">タスク1が入る　緑は生活</span><span class="col-sm-2" >2222年 22月 22日</span>  
            <div class="btn-group" role="group" aria-label="Basic example" class="col-sm-2">
              <button type="button" class="btn btn-primary update" data-toggle="modal" data-target="#update">更新</button>
              <button type="button" class="btn btn-danger">削除</button>
            </div>
          </div>
        </li>
        <li class="list-group-item category c2"> <!--class list-group-item category-orange-->
          <div class="row align-items-center">
            <span class="col-sm-8">タスク2が入る　オレンジは勉強</span><span class="col-sm-2" >2222年 22月 22日</span>  
            <div class="btn-group" role="group" aria-label="Basic example" class="col-sm-2">
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#update">更新</button>
              <button type="button" class="btn btn-danger">削除</button>
            </div>
          </div>
        </li>
        <li class="list-group-item category c3"> <!--class list-group-item category-orange-->
          <div class="row align-items-center">
            <span class="col-sm-8">タスク3が入る　青は仕事</span><span class="col-sm-2" >2222年 22月 22日</span>  
            <div class="btn-group" role="group" aria-label="Basic example" class="col-sm-2">
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#update">更新</button>
              <button type="button" class="btn btn-danger">削除</button>
            </div>
          </div>
        </li>
        <li class="list-group-item category c4 deadline" value="bye"> <!--class list-group-item category-orange-->
          <div class="row align-items-center">
            <span class="col-sm-8 task">タスク4が入る　ピンクは趣味</span><span class="col-sm-2" >2222年 22月 22日</span>  
            <div class="btn-group" role="group" aria-label="Basic example" class="col-sm-2">
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#update">更新</button>
              <button type="button" class="btn btn-warning warning" data-toggle="collapse" data-target="#deleteTest" aria-expanded="false" aria-controls="collapse">削除</button>
              </div>
            </div>
          </li>
          <!-- 動作テスト用コラプス -->
          <div class="collapse" id="deleteTest">
            <div class="card card-body">
              <div class="row">
                <div class="col-sm-9"><b>このタスクを削除しますか？</b></div>
                <div class="btn-group" role="group" aria-label="Basic example" class="col-sm-3">
                  <button type="button" class="btn btn-light" data-dismiss="modal">キャンセル</button>
                  <button type="button" class="btn btn-danger">削除</button>
                </div>
              </div> 
            </div>
          </div>
      </ul>
    </div>
      
    <!-- タスク追加モーダル -->
    <div class="modal fade" id="add" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">タスク登録</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <from>
              <div class="form-group">
                <label>タスク名</label>
                <input type="text" name="task" class="form-control">
              </div>
              <div class="form-group">
                <label>期限</label>
                <input type="date" name="deadline" class="form-control" class="date">
              </div>
              <div class="form-group">
                <label>カテゴリ</label>
                <select name="category" class="form-control">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                  <!-- <option>※自分でカテゴリ追加できたらいいな※</option> -->
                </select>
              </div>
            </from>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">キャンセル</button>
            <button type="button" class="btn btn-primary" id="create-task">追加</button>
          </div>
        </div>
      </div>
    </div>
    <!-- タスク追加モーダル ～完～-->
    <!-- タスク更新モーダル -->
    <div class="modal fade" id="update" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">タスク更新</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <from name="update-id" value="">
              <div class="form-group">
                <label>タスク名</label>
                <input type="text" name="update-task" class="form-control">
              </div>
              <div class="form-group">
                <label>期限</label>
                <input type="date" name="update-deadline" class="form-control date">
              </div>
              <div class="form-group">
                <label>カテゴリ</label>
                <select name="update-category" class="form-control">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                  <!-- <option>※自分でカテゴリ追加できたらいいな※</option> -->
                </select>
              </div>
              <div class="form-group">
                <label>ステータス</label>
                <select name="update-status" class="form-control">
                  <option value="1">完了</option>
                  <option value="2">作業中</option>
                  <option value="3">未実装</option>
                  <!-- <option>※自分でカテゴリ追加できたらいいな※</option> -->
                </select>
              </div>
            </from>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">キャンセル</button>
            <button type="button" class="btn btn-primary" id="update-task">更新</button>
          </div>
        </div>
      </div>
    </div>
    <!-- タスク更新モーダル ～完～-->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <!-- ｊQuery特有の$はjQuery導入スクリプトより後ろに書くこと -->
    <script src="../javascripts/index.js"></script>
    <script>
      // $("#delete-test").on("click",function () {
      //   const task = $(this).data("delete");
      //   console.log(task);
      //   $("#debug-delete").html(`下記の内容を削除します。\n ${task}`);
      // });

      // 取得メソッド
      $(async function () {
        const data = await httpGet(
          "//" + window.location.host + "/api/tasks");

        const list = data.map((item) => {
          const d = new Date(item.deadline);//timestanp->date
          const year = d.getFullYear();
          const month = ("0" + (d.getMonth() + 1)).slice(-2);//getMonthは1~12を0~11で返す。1を足して一桁に備えて2桁目に0を足している
          const date = ("0" + d.getDate()).slice(-2);//Dayだと曜日を数字で返す。なおDateは1~31で返してくれる。Monthだけなんで？？？？
          
          return `
          <li class="list-group-item category c${item.category_id}" name="id${item.id}">
            <div class="row align-items-center">
              <span class="col-sm-8 task">${item.task_name}</span><span class="col-sm-2 deadline">${year}年${month}月${date}日</span>  
              <div class="btn-group" role="group" aria-label="Basic example" class="col-sm-2">
                <button type="button" class="btn btn-primary update" data-toggle="modal" data-target="#update" value=${item.id}>更新</button>
                <button type="button" class="btn btn-warning warning" data-toggle="collapse" data-target="#delete${item.id}" aria-expanded="false" aria-controls="multi-collapse" value=${item.id}>削除</button>
              </div>
            </div>
          </li>
          <div class="collapse multi-collapse collapse-red" data-parent="#list-group" id="delete${item.id}">
            <div class="card card-body">
              <div class="row">
                <div class="col-sm-10"><b>このタスクを削除しますか？</b></div>
                <button type="button" class="btn btn-danger col-sm-1 delete" value="${item.id}">削除</button>
              </div> 
            </div>
          </div>`;
        })
        $('ul#list-group').append(list);
      });

      // 登録メソッド
      $('#create-task').on("click", async function () {
        const data = {
          taskName: $("[name=task]").val(),
          deadline: $("[name=deadline]").val(),
          category: $("[name=category]").val(),
        };

        const response = await httpPost(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + "/api/tasks",
          data
        );

        window.location.reload();
      });

      // 更新メソッド
      // DBから1件だけ情報取得
      $(document).on("click", ".update" , async function () {
        const update_id = $(this).val();

        const response = await httpGet(
          "//" + window.location.host + "/api/tasks/id",);

        response.forEach(item => {
          if(item.id == update_id){

            const d = new Date(item.deadline);//timestanp->date
            const year = d.getFullYear();
            const month = ("0" + (d.getMonth() + 1)).slice(-2);//getMonthは1~12を0~11で返す。1を足して一桁に備えて2桁目に0を足している
            const date = ("0" + d.getDate()).slice(-2);//Dayだと曜日を数字で返す。なおDateは1~31で返してくれる。Monthだけなんで？？？？
            
            $("[name=update-id]").val(update_id);
            $("[name=update-task]").val(item.task_name);
            $("[name=update-deadline]").val(year + "-" + month + "-" + date);
            $("[name=update-category]").val(item.category_id);
            $("[name=update-status]").val(item.task_status);
          }
        })
      });

        // DBを更新
      $('#update-task').on("click", async function () {
        const data = {
          id: $("[name=update-id]").val(),
          taskName: $("[name=update-task]").val(),
          deadline: $("[name=update-deadline]").val(),
          category: $("[name=update-category]").val(),//これだと新規タスクのフォームの値を参照することになる
          status: $("[name=update-status]").val()
        };

        const response = await httpUpdate(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + "/api/tasks",
          data
        );

        window.location.reload();
      });

      // 削除メソッド
      $(document).on('click', ".warning", async function() {
        if($(this).text() == "削除"){
          $('multi-collapse').collapse('hide');// 自分以外のコラプスを閉じる
          $('.warning').text('削除');// 他のキャンセルボタンを削除ボタンに直す
          $(`#delete${$(this).val()}`).collapse('show');// コラプスを開く
          $(this).text("キャンセル");

        } else if($(this).text() == "キャンセル"){// キャンセルボタン押したら削除に直す
          $(this).text('削除');
        }
      });
      //   // キャンセルボタン押したら削除に直す
      //   console.log($(this).text())
      //   if($(this).text() == "キャンセル"){
      //     console.log("ok")
      //     $(this).text('削除');
      //   }
      //   // 自分以外のコラプスを閉じる
      //   $('multi-collapse').collapse('hide');
      //   // 他のキャンセルボタンを削除ボタンに直す
      //   $('.warning').text('削除');
      //   // トグルを開く
      //   $(`#delete${$(this).val()}`).collapse('show');
      //   $(this).text("キャンセル");
      // });

      // 削除
      $(document).on('click', '.delete', async function(){
        const data = {
          id: $(this).val()
        }

        const response = await httpDelete(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + "/api/tasks",
          data
        );

        window.location.reload();
      });
    </script>
  </body>
</html>