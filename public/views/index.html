<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />

    <title>Todoアプリ</title>
  </head>
  <body>
    <div class="container">
      <!-- Content here -->
      <ul id="list-group" class="list-group">
        <li class="list-group-item category" id="add">
          <from class="form-horizontal">
            <div class="form-row align-items-bottom">
              <div class="col-sm-3">
                <div class="err">
                  <label>タスク名</label>
                  <span class="task-error"></span>
                </div>
                  <input type="text" name="task" class="form-control">
              </div>
              <div class="col-sm-2">
                <label>期限</label>
                <input type="date" name="deadline" class="form-control date">
              </div>
              <div class="col-sm-1" align-items="frex-end">
                <label></label>
                <button type="button" class="btn btn-outline-info btn-sm reset" id="re-add">
                  <b>締切ナシ</b>
                </button>
              </div>
              <div class="col-sm-2">
                <label>カテゴリ</label>
                <select name="category" class="form-control">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                  <!-- <option>※自分でカテゴリ追加できたらいいな※</option> -->
                </select>
              </div>
              <div class="btn-group col-sm-2 offset-sm-2" role="group" aria-label="Basic example">
                <button type="button" class="btn btn-success btn-lg" id="create-task">
                  <b>タスクを追加</b>
                </button>
              </div>
            </div>
          </from>
        </li>
      </ul>
    </div>
    <div class="rounded flex-column fixed">
      <button type="button" class="btn btn-primary rounded" id="all-update">更新</button>
      <button type="button" class="btn btn-warning rounded" id="all-update">削除</button>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <!-- ｊQuery特有の$はjQuery導入スクリプトより後ろに書くこと -->
    <script src="../javascripts/index.js"></script>
    <script>
      // 残り日数関数 0に期限、1にクラス
      function remain (deadline, status){
        console.log(deadline+status)

        let remains = ["", ""]
        const today = new Date()
        const oneDay = 86400000;
        const remain_ms = deadline  - today + oneDay;

        if(remain_ms <= 7*oneDay && status != 1){
          remains[0] = "あと"+ (Math.ceil(remain_ms / oneDay)) + "日";
          
          if(0 < remain_ms && remain_ms <= 3*oneDay){
            remains[1] = "near";
          }else if(remain_ms < 0){
            remains[1] = "out";
            remains[0] = "期限切れ"
          }
        }
        
        return remains;
      }

      // クラス取得してnearやoutがないかを確認
      function changeRemain (id, remains){

        const changeT = $(`li[name=id${id}]`).attr("class").split(' ');
        changeT.map((item) => {
            if(item == "near" || item == "out"){
              $(`li[name=id${id}]`).removeClass("near")
              $(`li[name=id${id}]`).removeClass("out")
            } 
          })
          console.log(remains[0])
          // クラスと残り日数を更新
          $(`li[name=id${id}] .remain`).text(remains[0])
          $(`li[name=id${id}]`).addClass(remains[1])
      }

      // 取得メソッド
      $(async function () {
        const data = await httpGet(
          "//" + window.location.host + "/api/tasks");

        const list = data.map((item) => {
          console.log(item.id+"  OK")
          let deadlineVal = null;
          let deadlineValData = null;
          let remains = ["", ""];
          
          if(item.deadline == null){
            deadlineVal = "（期限ナシ）";
          }else{
            const d = new Date(item.deadline);//timestanp->date
            const year = d.getFullYear();
            const month = ("0" + (d.getMonth() + 1)).slice(-2);//getMonthは1~12を0~11で返す。1を足して一桁に備えて2桁目に0を足している
            const date = ("0" + d.getDate()).slice(-2);//Dayだと曜日を数字で返す。なおDateは1~31で返してくれる。Monthだけなんで？？？？
            deadlineVal = `${year}年${month}月${date}日`;
            deadlineValData = `${year}-${month}-${date}`;

            // 残り日数に応じてクラス付与
            remains = remain(d, item.task_status)
          }
          return `
          <li
           class="list-group-item category 
           update-task
           c${item.category_id} 
           ${remains[1]}" 
           name="id${item.id}">
            <div class="row align-items-center">
              <input name="update-id" value="${item.id}" style="display:none">
              <div class="col-sm-3 toggle" name="task" data-id="${item.id}">
                <a class="task task${item.id}">${item.task_name}</a>
                <input type="text" name="update-task" id="update-task${item.id}" class="form-control" style="display:none" value="${item.task_name}">
              </div>
              <div class="col-sm-2 toggle" name="deadline" data-id="${item.id}">
                <a class="deadline deadline${item.id}">${deadlineVal}</a>
                <input type="date" name="update-deadline" id="update-deadline${item.id}" class="form-control" style="display:none" value="${deadlineValData}">
              </div>
              <div class="col-sm-1 remain">${remains[0]}</div>  
              <div class="col-sm-2">
                <select name="update-category" class="form-control custom-select" data-id="${item.id}" data-initial="${item.category_id}">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                  <!-- <option>※自分でカテゴリ追加できたらいいな※</option> -->
                </select></div>
              <div class="col-sm-2 status">
                <select name="update-status" class="form-control custom-select s${item.task_status}" data-id="${item.id}" data-initial="${item.task_status}">
                  <option value="1">完了</option>
                  <option value="2">作業中</option>
                  <option value="3">未実装</option>
                  <!-- <option>※自分でカテゴリ追加できたらいいな※</option> -->
                </select></div>
              <div class="btn-group col-sm-2" role="group" aria-label="Basic example">
                <button
                 type="button" 
                 class="btn btn-primary update" 
                 data-toggle="modal" 
                 data-target="#update" 
                 value=${item.id}>更新</button>
                <button
                 type="button" 
                 class="btn btn-warning warning" 
                 data-toggle="collapse" 
                 data-target="#delete${item.id}" 
                 aria-expanded="false" 
                 aria-controls="multi-collapse" 
                 value=${item.id}>削除</button>
              </div>
            </div>
          </li>
          <div class="collapse multi-collapse back-red" data-parent="#list-group" id="delete${item.id}">
            <div class="card card-body">
              <div class="row align-items-center">
                <div class="col-sm-10"><b>このタスクを削除しますか？</b></div>
                <button type="button" class="btn btn-danger col-sm-1 delete" value="${item.id}">削除</button>
              </div>
            </div>
          </div>`;
        })
        $('ul#list-group').append(list);

        // タスク表示時の細かな処理
        // 更新フォームのカテゴリーに初期値を装備
        $(".c1 option[value=1]").prop('selected', true)//.c1じゃなくてnameでいいかも
        $(".c2 option[value=2]").prop('selected', true)
        $(".c3 option[value=3]").prop('selected', true)
        $(".c4 option[value=4]").prop('selected', true)
        $(".s1 option[value=1]").prop('selected', true)// .sじゃなくてname判断でいいかも
        $(".s2 option[value=2]").prop('selected', true)
        $(".s3 option[value=3]").prop('selected', true)
        $(".s4 option[value=4]").prop('selected', true)

        // 期限ナシの時に字を薄くする
        $("a.deadline:contains('（期限ナシ）')").css('color', 'rgb(200, 200, 200)')
      });

      // 登録フォームエラー確認
      $('#add input[name=task]').focusout(async function(){
        if($(this).val() == ""){
          $('#add .task-error').text("※入力必須").css('color', 'red');
          $('#add input[name=task]').css('background-color', "rgb(255, 230, 230)")
        }else if($(this).val().length > 255){
          $('#add .task-error').text("※255字以内で入力").css('color', 'red');
          $('#add input[name=task]').css('background-color', "rgb(255, 230, 230)")
        }else{
          $('#add .task-error').text("");
          $('#add input[name=task]').css('background-color', "rgb(255, 255, 255)")
        }
      });

      // 期限リセット
      $(document).on('click', '.reset', async function() {
        const reset = $(this).attr('id')
        if(reset=="re-add"){
          $("#add input[name=deadline]").val("");
        }else{
          $("#update input[name=deadline]").val("");
        }
      });

      // 登録メソッド
      $('#create-task').on("click", async function () {
        const data = {
          taskName: $("#add input[name=task]").val(),
          deadline: $("#add input[name=deadline]").val(),
          category: $("#add select[name=category]").val(),
        };

        if(data.taskName == ''){
          $('#add .task-error').text("※入力必須").css('color', 'red');
          $('#add input[name=task]').css('background-color', "rgb(255, 230, 230)")
        }else{
          const response = await httpPost(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + "/api/tasks",
          data
          );

          window.location.reload();
        }
      });

      // 更新メソッド
      // クリックしたらinputに
      $(document).on("click",".update-task div.toggle", async function() {
        const id = $(this).data("id");
        const name = $(this).attr("name");
        
        $(`#update-${name}${id}`).show();
        $(`#update-${name}${id}`).focus();
        $(`a.${name}${id}`).hide();
      })
      // 逃げたらaに切り替え
      $(document).on("focusout",".update-task div.toggle", async function() {
        const id = $(this).data("id");
        const name = $(this).attr("name");
        
        $(`a.${name}${id}`).show();
        $(`#update-${name}${id}`).hide();
      })
      // aのtextは常にinputを参照する
      $(document).on("change",".update-task div.toggle", async function() {
        const id = $(this).data("id");
        const name = $(this).attr("name");
        let text = $(`#update-${name}${id}`).val();
        const ymd = text.split("-")

        // deadlineの時はyyyy-mm-ddから年月日に変えてから入れる
        if(name == "deadline"){
          if(ymd == "") text = "（期限ナシ）"
          else text = `${ymd[0]}年${ymd[1]}月${ymd[2]}日`;

          // 締切変更時に警告と残り日数を更新
          const d = new Date(`${ymd[0]}-${ymd[1]}-${ymd[2]}`);
          const status = $(`li[name=id${id}] select[name=status]`).val();
          
          const remains = remain(d, status)
          
          // クラス取得してnearやoutがないかを確認
          changeRemain(id, remains)
        }
        // aのtextにinputのvalueを代入
        $(`a.${name}${id}`).text(text); 
      })

      // 更新用selectの変更検知
      $(document).on("change",".update-task select", async function() {

        const id = $(this).data("id");
        const name = $(this).attr("name")
        const initial = $(this).data("initial");
        const val = $(this).val()

        if(val == initial) $(this).css("background", "rgb(255, 255, 255");
        else $(this).css("background", "rgb(200, 230, 255")
        
        if(name=="update-status"){
          const d =  new Date($(`#update-deadline${id}`).val())
          if(d != "Invalid Date") changeRemain(id, remain(d, val))//期限ナシだとdはInvalid Dateになるし期限ナシならステータス気にしなくていい
        }
      })

        // DBを更新
      $(document).on("click", '.update', async function () {
        const id = $(this).val();
        const data = {
          id:       $(`.update-task[name=id${id}] input[name=update-id]`).val(),
          taskName: $(`.update-task[name=id${id}] input[name=update-task]`).val(),
          deadline: $(`.update-task[name=id${id}] input[name=update-deadline]`).val(),
          category: $(`.update-task[name=id${id}] select[name=update-category]`).val(),//
          status:   $(`.update-task[name=id${id}] select[name=update-status]`).val()
        };
        console.log(data);
        const response = await httpUpdate(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + `/api/tasks/${data.id}`,
          data
        );

        window.location.reload();
      });

      // 一括更新はmap使って一個ずつSQL作動させて実現可能？（岩崎さんのパクるで！！）
      $(document).on("click", '.update', async function () {
        const id = $(this).val();
        const data = {
          id:       $(`.update-task[name=id${id}] input[name=update-id]`).val(),
          taskName: $(`.update-task[name=id${id}] input[name=update-task]`).val(),
          deadline: $(`.update-task[name=id${id}] input[name=update-deadline]`).val(),
          category: $(`.update-task[name=id${id}] select[name=update-category]`).val(),//
          status:   $(`.update-task[name=id${id}] select[name=update-status]`).val()
        };
        console.log(data);
        const response = await httpUpdate(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + `/api/tasks/${data.id}`,
          data
        );

        window.location.reload();
      });

      // 削除メソッド
      $(document).on('click', ".warning", async function() {

        if($(this).text() == "削除"){
          $('multi-collapse').collapse('hide');// 自分以外のコラプスを閉じる
          $('.warning').text('削除');// 他のキャンセルボタンを削除ボタンに直す
          $(`#delete${$(this).val()}`).collapse('show');// コラプスを開く
          $(this).text("キャンセル");

        } else if($(this).text() == "キャンセル"){// キャンセルボタン押したら削除に直す
          $(this).text('削除');
        }
      });

      // 削除
      $(document).on('click', '.delete', async function(){

        const id = $(this).val();

        const response = await httpDelete(//httpPostはjavascript/index.jsに有り
          "//" + window.location.host + `/api/tasks/${id}`
        );

        window.location.reload();
      });
    </script>
  </body>
</html>